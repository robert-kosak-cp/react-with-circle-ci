# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Executors ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

executors:
  with-chrome-and-firefox:
    docker:
      - image: "cypress/browsers:node16.14.2-slim-chrome100-ff99-edge"
    resource_class: large

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Contexts ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
docker_node: &docker_node
  docker:
    - image: cimg/node:16.18.0

staging_branch: &staging_branch
  filters:
    branches:
      only:
        - staging

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Jobs ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

jobs:
  compile_app:
    resource_class: large
    <<: *docker_node
    description: Create a development build
    steps:
      - checkout
      - run:
          name: 'Yarn install'
          command: 'yarn install'
      - save_cache:
          key: v1-dep-{{ checksum "yarn.lock" }}
          paths:
            - node_modules
      - run:
          name: 'Run yarn build'
          command: 'yarn build'
      - run:
          name: 'Serve'
          command: 'yarn global add serve'

orbs:
  cypress: cypress-io/cypress@2.2.0
workflows:
  build_and_test:
    jobs:
      - compile_app
      - cypress/run:
          name: "e2e_chrome_desktop"
          browser: chrome
          group: "E2E - Chrome"
          executor: with-chrome-and-firefox
          requires:
            - compile_app
          parallelism: 5
          start: yarn start
          wait-on: 'http://localhost:3000'
          post-steps:
            - run: npx cypress run --record --key ${CY_CLOUD_RECORD_KEY}
      - cypress/run:
          name: "E2E Firefox desktop"
          browser: firefox
          group: "E2E - Firefox"
          executor: with-chrome-and-firefox
          requires:
            - compile_app
            - e2e_chrome_desktop
          parallelism: 4
          start: yarn start
          wait-on: 'http://localhost:3000'